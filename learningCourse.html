<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<style type="text/css">
			html {
				height: 100%;
				background-color: #FFFFFF;
			}
			
			body {
				font-family: "微软雅黑";
				color: #333333;
			}
			
			li {
				list-style: none;
			}
			
			body .mui-bar-nav {
				background-color: #e93f32;
			}
			
			.mui-bar h1 {
				color: #FFFFFF;
				font-family: "微软雅黑";
				font-size: 20px;
			}
			
			.mui-bar-nav a {
				color: #FFFFFF;
			}
			
			#table_one {
				font-family: "微软雅黑";
				color: #333333;
				position: relative;
				height: 36px;
				padding: 0;
				margin: 0;
				display: -webkit-box;
				-webkit-box-pack: justify;
				background-color: #FFFFFF
			}
			
			#table_one>li {
				width: 100%;
				font-size: 15px;
				height: 36px;
				line-height: 36px;
				text-align: center;
			}
			
			#table_one>li>a {
				color: #909090;
			}
			
			#table_one>li:nth-of-type(1) {
				-webkit-box-flex: 1;
			}
			
			#table_one>li:nth-of-type(2) {
				-webkit-box-flex: 1;
			}
			
			#table_one>li:nth-of-type(3) {
				-webkit-box-flex: 1;
			}
			
			#table_one>li:nth-of-type(1):after {
				content: "";
				display: block;
				background-color: #d9d9d9;
				height: 16px;
				width: 1px;
				float: right;
				margin-top: 10px;
			}
			
			#table_one>li:nth-of-type(2):after {
				content: "";
				display: block;
				background-color: #d9d9d9;
				height: 16px;
				width: 1px;
				float: right;
				margin-top: 10px;
			}
			
			#table_one>li>ul {
				display: none;
				width: 100%;
				padding: 0;
				margin: 0;
				position: absolute;
				left: 0;
				top: 36px;
				background-color: #FFFFFF;
				margin-bottom: 42px;
			}
			
			#table_index>li {
				padding: 0 16px;
				text-align: left;
				font-size: 14px;
				height: 50px;
				line-height: 50px;
			}
			
			body .mui-bar-tab {
				height: 42px;
			}
			
			body .mui-bar-tab .mui-tab-item {
				height: 42px;
				box-sizing: border-box;
			}
			
			#table_one>li .table {
				display: block;
			}
			
			footer {
				width: 100%;
				height: 42px;
				position: fixed;
				bottom: 0;
				left: 0;
				border-top: 1px solid #ececec;
				z-index: 999;
				background-color: #FFFFFF;
				padding-right: 37px;
			}
			/*视屏播放控制*/
			
			#myVideo {
				width: 100%;
			}
			
			footer>.mui-icon {
				height: 42px;
				width: 42px;
				line-height: 42px;
				text-align: center;
				font-size: 20px;
				float: right;
				display: block;
			}
			
			#table_index>li>span {
				font-size: 10px;
				margin-bottom: 19px;
				margin-right: 8px;
			}
			
			#table_index>li>b {
				position: absolute;
				right: 16px;
				font-weight: 500;
			}
			
			#table_one>li .click {
				color: #E93F32;
			}
			
			.video-js {
				width: 100%;
			}
			/*我的心得*/
			
			#get_list>li {
				border-top: 1px solid #e3e2e2;
				padding: 15px;
			}
			
			#get_list>li:after {
				content: "";
				display: block;
				clear: both;
			}
			
			#get_list>li>img {
				display: block;
				border-radius: 50%;
				height: 30px;
				width: 30px;
				float: left;
				margin-right: 10px;
			}
			
			#get_list>li>div {
				float: left;
			}
			
			#get_list>li>div>h3 {
				text-align: left;
				font-size: 15px;
				color: #434343;
				margin-bottom: 10px;
			}
			
			#get_list>li>div>p {
				text-align: left;
				font-size: 14px;
				color: #999999;
				line-height: 16px;
				margin-bottom: 17px;
			}
			
			#get_list>li>div>h6 {
				text-align: left;
				font-size: 11px;
				color: #c7c7c7;
			}
			
			#talk_list {
				padding: 0;
				margin: 0;
			}
			
			#talk_list>li {
				border-top: 1px solid #e3e2e2;
				padding: 15px;
				margin-top: 5px;
				background-color: #FFFFFF
			}
			
			#talk_list>li>ul {
				padding: 0;
				margin: 0;
				float: left;
			}
			
			#talk_list li:after {
				content: "";
				display: block;
				clear: both;
				height: 0;
			}
			
			#talk_list>li img {
				display: block;
				border-radius: 50%;
				height: 30px;
				width: 30px;
				float: left;
				margin-right: 10px;
			}
			
			#talk_list>li>div {
				float: left;
			}
			
			#talk_list>li>ul>li>div {
				float: left;
			}
			
			#talk_list>li div>h3 {
				text-align: left;
				font-size: 15px;
				color: #434343;
				margin-bottom: 10px;
			}
			
			#talk_list>li div>p {
				text-align: left;
				font-size: 14px;
				color: #999999;
				line-height: 16px;
				margin-bottom: 7px;
			}
			
			#talk_list>li div .time {
				line-height: 30px;
				height: 30px;
			}
			
			#talk_list>li div .time h6 {
				height: 30px;
				line-height: 30px;
				margin: 0;
				text-align: left;
				font-size: 11px;
				color: #c7c7c7;
				float: left;
			}
			
			#talk_list>li div .time:after {
				content: "";
				display: block;
				clear: both;
			}
			
			#talk_list>li div .time .rightback {
				line-height: 30px;
				height: 30px;
				color: #d5d5d5;
				font-size: 11px;
				float: right;
			}
			
			.talkback {
				float: left;
				width: calc(100% - 40px);
			}
			
			#get_list>button {
				display: block;
				border-radius: 0;
				margin: 0;
				width: 100%;
				border-bottom: 0;
			}
		</style>
		<link rel="stylesheet" type="text/css" href="css/iconfont.css" />
		<link rel="stylesheet" href="css/video-js.min.css" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<script src="js/video.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/videojs-contrib-hls.js" type="text/javascript" charset="utf-8"></script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" id="title">行动日志——成功人士的</h1>
		</header>
		<footer>
			<span class="mui-icon iconfont icon-fenxiang" style="color: #E93F32;" id="share"></span>
			<span class="mui-icon iconfont icon-shoucang" style="color: #acabab;font-size: 25px;" id="collection"></span>
		</footer>
		<div class="mui-content">
			<video id="myVideo" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" poster="images/course/logo.jpg" ata-setup="{}">
				<source src="http://7xpfpu.com2.z0.glb.qiniucdn.com/32c21bb95cb74a929149eb8165d85cfb.m3u8" type="application/x-mpegURL"></source>
			</video>
			<ul id="table_one">
				<li>
					<a href="javascript:void(0);" class="click">目录</a>
					<ul id="table_index" class="table">
						<li id="childTitle">课程名称：行动日志——成功人士的五项修炼</li>
					</ul>
				</li>
				<li>
					<a href="javascript:void(0);">心得</a>
					<ul id="get_list">
						<button type="button" id="addCourseGet">输入课程心得</button>
						<li>
							<img src="images/course/weixin.png" />
							<div class="talkback">
								<h3>匿名</h3>
								<p>感觉很好还不错学到了很多知识嘻嘻</p>
								<h6>2016-04-23   10:05:01</h6>
							</div>
						</li>
						<li>
							<img src="images/course/weixin.png" />
							<div class="talkback">
								<h3>匿名</h3>
								<p>感觉很好还不错学到了很多知识嘻嘻</p>
								<h6>2016-04-23   10:05:01</h6>
							</div>
						</li>
						<li>
							<img src="images/course/weixin.png" />
							<div class="talkback">
								<h3>匿名</h3>
								<p>感觉很好还不错学到了很多知识嘻嘻</p>
								<h6>2016-04-23   10:05:01</h6>
							</div>
						</li>
						<li>
							<img src="images/course/weixin.png" />
							<div class="talkback">
								<h3>匿名</h3>
								<p>感觉很好还不错学到了很多知识嘻嘻感觉很好还不错学到了很</p>
								<h6>2016-04-23   10:05:01</h6>
							</div>
						</li>
					</ul>
				</li>
				<li>
					<a href="javascript:void(0);">讨论</a>
					<ul id="talk_list">
						<li>
							<img src="images/course/weixin.png" />
							<div class="talkback">
								<h3>匿名</h3>
								<p>感觉很好还不错学到了很多知识嘻嘻</p>
								<div class="time">
									<h6>2016-04-23   10:05:01</h6>
									<div class="rightback">
										<span class="mui-icon iconfont icon-taolun"></span>
										<span>0</span>
										<span class="mui-icon iconfont icon-xuexi"></span>
										<span>回答</span>
									</div>
								</div>
							</div>
						</li>
						<li>
							<img src="images/course/weixin.png" />
							<div class="talkback">
								<h3>匿名</h3>
								<p>感觉很好还不错学到了很多知识嘻嘻</p>
								<div class="time">
									<h6>2016-04-23   10:05:01</h6>
									<div class="rightback">
										<span class="mui-icon iconfont icon-taolun"></span>
										<span>0</span>
										<span class="mui-icon iconfont icon-xuexi"></span>
										<span>回答</span>
									</div>
								</div>
							</div>
						</li>
						<li>
							<img src="images/course/weixin.png" />
							<div class="talkback">
								<h3>匿名</h3>
								<p>感觉很好还不错学到了很多知识嘻嘻</p>
								<div class="time">
									<h6>2016-04-23   10:05:01</h6>
									<div class="rightback">
										<span class="mui-icon iconfont icon-taolun"></span>
										<span>0</span>
										<span class="mui-icon iconfont icon-xuexi"></span>
										<span>回答</span>
									</div>
								</div>
							</div>
						</li>
						<li>
							<img src="images/course/weixin.png" />
							<div class="talkback">
								<h3>匿名</h3>
								<p>感觉很好还不错学到了很多知识嘻嘻</p>
								<div class="time">
									<h6>2016-04-23   10:05:01</h6>
									<div class="rightback">
										<span class="mui-icon iconfont icon-taolun"></span>
										<span>0</span>
										<span class="mui-icon iconfont icon-xuexi"></span>
										<span>回答</span>
									</div>
								</div>
							</div>
						</li>
					</ul>
				</li>
			</ul>
		</div>
		<script src="js/jquery-2.1.0.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/extra.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" charset="UTF-8">
		    //定义计时器对象。
			var timesend = null;
			//**************切换按钮函数
			function chatAndAnswer(buttons, contens, classNames) {
				for(var i = 0; i < buttons.length; i++) {
					(function(i) {
						buttons.eq(i).on('click', function() {
							$(this).children('a').addClass(classNames);
							contens.eq(i).show();
							for(var j = 0; j < buttons.length; j++) {
								if(i != j) {
									buttons.eq(j).children('a').removeClass(classNames);
									contens.eq(j).hide();
								}
							}
						})
					}(i))
				}
			}
			//*************时间格式化函数
			function getNowFormatDate() {
				var date = new Date();
				var seperator1 = "-";
				var seperator2 = ":";
				var month = date.getMonth() + 1;
				var strDate = date.getDate();
				if(month >= 1 && month <= 9) {
					month = "0" + month;
				}
				if(strDate >= 0 && strDate <= 9) {
					strDate = "0" + strDate;
				}
				var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate + " " + date.getHours() + seperator2 + date.getMinutes() + seperator2 + date.getSeconds();
				return currentdate;
			}
			/**********创建课程列表函数*********/
			function creatList(courselist) {
				var famework = document.createDocumentFragment();
				var li;
				for(var i = 0; i < courselist.length; i++) {
					li = document.createElement("li");
					li.setAttribute('data-src', courselist[i].Src);
					li.id = courselist[i].Id;
					li.innerHTML = '<span class="mui-icon iconfont icon-yousanjiao"></span>' + (i + 1) + '.' + courselist[i].Title + '<b>' + courselist[i].PassTime + '分钟</b>'
					famework.appendChild(li);
				}
				return famework;
			}

			/*********创建我的心得列表*********/
			function creatgetlist(list) {
				var frame = document.createDocumentFragment();
				var li;
				for(var i = 0; i < list.length; i++) {
					li = document.createElement("li");
					li.innerHTML = '<img src=' + list[i].Src + ' /><div class="talkback"><h3>' + list[i].UserName + '</h3><p>' + list[i].Contect + '</p><h6>' + list[i].Time + '</h6>'
					frame.appendChild(li);
				}
				return frame;
			}

			/**********添加我的心得函数************/
			function creatnewget(src, name, texts, time) {
				var li = document.createElement("li")
				li.innerHTML = '<img src=' + src + ' /><div class="talkback"><h3>' + name + '</h3><p>' + texts + '</p><h6>' + time + '</h6>'
				return li;
			}

			//************创建我的讨论回复列表
			function creatbacklist(list) {
				var li = "";
				for(var i = 0; i < list.length; i++) {
					li += '<img src=' + list[i].imgsrc + ' /><div class="talkback"><h3>' + list[i].name + '</h3><p>' + list[i].p + '</p><div class="time"><h6>' + list[i].time + '</h6><div class="rightback"><span class="mui-icon iconfont icon-xuexi"></span><span  class="answer_two">回答</span></div></div></div>'
				}
				return li;
			}
			//**************创建我的讨论一级列表
			function creattalklist(list) {
				var frame = document.createDocumentFragment();
				var li;
				for(var i = 0; i < list.length; i++) {
					li = document.createElement("li");
					li.innerHTML = '<img src=' + list[i].imgsrc + ' /><div class="talkback"><h3>' + list[i].name + '</h3><p>' + list[i].p + '</p><div class="time"><h6>' + list[i].time + '</h6><div class="rightback"><span class="mui-icon iconfont icon-taolun"></span><span>' + list[i].number + '</span><span class="mui-icon iconfont icon-xuexi"></span><span class="answer">回答</span></div></div></div><ul class="callback">' + creatbacklist(list[i].backlist) + '</ul>'
					frame.appendChild(li);
				}
				return frame;
			}
			//*************视屏播放函数
			function resetPlayer(player, src, auto, data, header) {
				player.src({
					type: "application/x-mpegURL",
					src: src
				});
				//视屏重置
				player.load();
				//首先清除计时器
				clearInterval(timesend);
				//设置自动播放属性的时候进行播放
				if(auto) {
					player.ready(function() {
						this.play();
					})
				};
				player.on('play', function() {
					timesend = setInterval(function() {
						data.Time = player.currentTime();
						var send_data = JSON.stringify({
							Body: data,
							Header: header
						});
						sendAjax('api/Course/SaveLearnWare', send_data, function() {
						})
					}, 10000);
				});
				player.on('pause', function() {
					clearInterval(timesend);
				})
			}

			mui.plusReady(function() {
				mui.init();
				/*var courselist = {
						title: "心动日志-成功人士的",
						childTitle: "行动日志-成功人士的五项基本修炼",
						courseList: [{
							title: "行动日志-成功人士的五项基本修炼",
							time: "31:02"
						}, {
							title: "行动日志-成功人士的五项基本修炼",
							time: "31:02"
						}, {
							title: "行动日志-成功人士的五项基本修炼",
							time: "31:02"
						}, {
							title: "行动日志-成功人士的五项基本修炼",
							time: "31:02"
						}, {
							title: "行动日志-成功人士的五项基本修炼",
							time: "31:02"
						}, {
							title: "行动日志-成功人士的五项基本修炼",
							time: "31:02"
						}, {
							title: "行动日志-成功人士的五项基本修炼",
							time: "31:02"
						}]
					}
				var getlist = [{
					imgsrc: "images/course/weixin.png",
					name: "匿名",
					p: "感觉很好还不错学到了很多知识嘻嘻",
					time: "2016-04-23   10:05:01"
				}, {
					imgsrc: "images/course/weixin.png",
					name: "匿名",
					p: "感觉很好还不错学到了很多知识嘻嘻",
					time: "2016-04-23   10:05:01"
				}, {
					imgsrc: "images/course/weixin.png",
					name: "匿名",
					p: "感觉很好还不错学到了很多知识嘻嘻",
					time: "2016-04-23   10:05:01"
				}, {
					imgsrc: "images/course/weixin.png",
					name: "匿名",
					p: "感觉很好还不错学到了很多知识嘻嘻",
					time: "2016-04-23   10:05:01"
				}, ];
				var talklist = [{
					imgsrc: "images/course/weixin.png",
					name: "匿名",
					p: "感觉很好还不错学到了很多知识嘻嘻",
					time: "2016-04-23   10:05:01",
					number: "3",
					backlist: [{
						imgsrc: "images/course/weixin.png",
						name: "匿名",
						p: "感觉很好还不错学到了很多知识嘻嘻",
						time: "2016-04-23   10:05:01"
					}, {
						imgsrc: "images/course/weixin.png",
						name: "匿名",
						p: "感觉很好还不错学到了很多知识嘻嘻",
						time: "2016-04-23   10:05:01"
					}, {
						imgsrc: "images/course/weixin.png",
						name: "匿名",
						p: "感觉很好还不错学到了很多知识嘻嘻",
						time: "2016-04-23   10:05:01"
					}, ]
				}, {
					imgsrc: "images/course/weixin.png",
					name: "匿名",
					p: "感觉很好还不错学到了很多知识嘻嘻",
					time: "2016-04-23   10:05:01",
					number: "3",
					backlist: []
				}];*/

				
				//浏览器播放对象
				var myPlayer = videojs('myVideo');
				//目录页标题
				var title = document.getElementById("title");
				//课程列表标题
				var childTitle = document.getElementById("childTitle");
				//课程列表
				var table_index = document.getElementById("table_index");
				//我的心得列表
				var getList = document.getElementById("get_list");
				//我的讨论列表
				var talkList = document.getElementById("talk_list");
				//是否允许移动网络下播放
				var netType = plus.storage.getItem('netType');
				//是否允许自动播放
				var autoPlay = plus.storage.getItem('autoPlay');

				var CourseId = null; //课程id
				var WareId = null; //课件id
				var SortId = null; //章节id
				var wareType = 2; //2
				var RecordId = null; //课程学习记录
				var Time = null; //当前学习时间

				/*******渲染课程目录树结构********/
				(function() {
					//页面打开后获取到所携带的额外参数
					var thisWbview = plus.webview.currentWebview();
					//获取到的所有数据；
					var data = thisWbview.data;
					CourseId = data.WareId;
					WareId = data.CourseId;
					RecordId = data.RecordId;
					var header = JSON.parse(plus.storage.getItem('header'));
					var courseList = JSON.stringify({
						Body: {
							LearnProcess: data.LearnProcess,
							WareId: data.WareId,
							Id: data.CourseId
						},
						Header: header,
					});
					var getLists = JSON.stringify({
						Body: {
							PageIndex: 1,
							PageSize: 99,
							CourseId: data.CourseId
						},
						Header: header,
					});
					console.log(getList);
					//课程目录渲染过程
					sendAjax('api/Course/GetCourseWareTree', courseList, function(data) {
						console.log(JSON.stringify(data));
						//***标题的更改 
						title.innerHTML = data.Body.Title;
						//***二级标题的更改
						childTitle.innerHTML = data.Body.Title;
						//列表的渲染
						table_index.appendChild(creatList(data.Body.children));

						mui(table_index).on('tap', 'li', function() {
							SortId = this.id;
							var src = this.getAttribute('data-src');
							console.log(src);
							var sendData = {
								CourseId: CourseId,
								WareId: WareId,
								SortId: SortId,
								wareType: 2,
								RecordId: RecordId,
								Time:Time
							};
							resetPlayer(myPlayer, src, autoPlay, sendData, header);
						})
					});
					//课程我的心得渲染过程
					sendAjax('api/Course/GetCourseXinDe', getLists, function(data) {
						//*******数据渲染
						getList.appendChild(creatgetlist(data.Body.Items));
					})
				})();

				window.addEventListener('newsId', function(event) {
					//获得事件参数
					var id = event.detail.id;

					mui.get('http://server-name/list.php', {
						courseid: id
					}, function(data) {
						//获得服务器响应
						title.innerHTML = data.title;
						childTitle.innerHTML = data.childTitle;
						table_index.innerHTML += creatList(data);
					}, 'json');
					//根据id向服务器请求课程详情
				});

				//*******table页的切换
				chatAndAnswer($('#table_one>li'), $('#table_one>li>ul'), 'click');

				/********控制课程目录的背景颜色间隔*********/
				(function() {
					var indexs = document.getElementById("table_index").getElementsByTagName("li");
					for(var i = 0; i < indexs.length; i++) {
						if(i % 2 == 0) {
							indexs[i].style.backgroundColor = "#f5f5f5";
						}
					}
				})()

				//***********重写back函数，退出后会关闭整个页面
				var thiswebview = plus.webview.currentWebview();
				mui.back = function() {
					plus.webview.close(thiswebview);
				}
				document.getElementById("addCourseGet").addEventListener('click', function(e) {
					//修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
					var btnArray = ['取消', '确定'];
					mui.prompt('请输入你的心得：', '很有收获', 'Hello ZJZX', btnArray, function(e) {
						if(e.index == 1) {
							var src = "images/course/weixin.png";
							//获取img的src值
							var time = getNowFormatDate();
							//获取回复时的时间
							var thisname = '誓约胜利之剑';
							//回复的昵称，本人的昵称 
							$("#get_list").append(creatnewget(src, thisname, e.value, time));
						}
					})
				})

				$('.answer_two').on("tap", function(e) {
					//修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
					var btnArray = ['取消', '确定'];
					var that = $(this)
					mui.prompt('请输入你的评论：', '老师讲的好', 'Hello ZJZX', btnArray, function(e) {
						if(e.index == 1) {
							var src = that.parents('.talkback').prev('img').attr('src');
							//获取img的src值
							var backname = that.parents('.talkback').children('h3').html().split('回复')[0];
							//获取需要回复的昵称
							var time = getNowFormatDate();
							//获取回复时的时间
							var thisname = '誓约胜利之剑';
							//回复的昵称，本人的昵称 
							that.parents('.callback').append(creatAnswer(src, thisname + '  回复   ' + backname, e.value, time));

						}
					})
				});
				//为一级目录添加回复事件
				$('.answer').on("click", function(e) {
					//修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
					var btnArray = ['取消', '确定'];
					var that = $(this)
					mui.prompt('请输入你的评论：', '老师讲的好', 'Hello ZJZX', btnArray, function(e) {
						if(e.index == 1) {
							var src = that.parents('.talkback').prev('img').attr('src');
							//获取img的src值
							var backname = that.parents('.talkback').children('h3').html().split('回复')[0];
							//获取需要回复的昵称
							var time = getNowFormatDate();
							//获取回复时的时间
							var thisname = '誓约胜利之剑';
							//回复的昵称，本人的昵称 
							that.parents('li').children('.callback').append(creatAnswer(src, thisname + '  回复   ' + backname, e.value, time));

						}
					})
				});

				//定义回复事件的dom操作
				function creatAnswer(src, name, texts, time) {
					var li = document.createElement("li")
					li.innerHTML = '<img src=' + src + ' /><div class="talkback"><h3>' + name + '</h3><p>' + texts + '</p><div class="time"><h6>' + time + '</h6><div class="rightback"><span class="mui-icon iconfont icon-xuexi"></span><span class="answer_two">回答</span></div></div></div>'
					return li;
				}

			})
		</script>
	</body>

</html>